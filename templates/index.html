<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Real Visit Panel — Live</title>
<style>
  body{font-family:Inter,Arial;background:#041226;color:#e6f6ff;margin:0;padding:18px;display:flex;justify-content:center}
  .card{width:380px;background:linear-gradient(180deg,#061226,#0a2740);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  h2{margin:0 0 12px 0;color:#8ee7ff}
  input,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:0;font-size:15px}
  input{background:#082033;color:#cfefff}
  button{background:#0ea5ff;color:#022;cursor:pointer;font-weight:700}
  .progress{height:18px;background:#08324a;border-radius:8px;overflow:hidden;margin-top:10px}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#00ff9e,#00a6ff);transition:width .3s}
  .meta{margin-top:8px;color:#bfefff;font-size:14px}
  .small{font-size:13px;color:#9fd8ff;margin-top:6px}
  .log{background:#021726;padding:8px;border-radius:8px;margin-top:10px;color:#bfefff;font-size:12px;height:110px;overflow:auto}
</style>
</head>
<body>
  <div class="card">
    <h2>Real Visit Panel</h2>

    <div id="loginArea">
      <input id="user" placeholder="Username (admin)" />
      <input id="pass" placeholder="Password (1234)" type="password" />
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="small"></div>
    </div>

    <div id="panel" style="display:none">
      <input id="uid" placeholder="UID (e.g. 1593717951)" />
      <input id="target" placeholder="Visits needed (e.g. 100)" type="number" />
      <div style="display:flex;gap:8px">
        <button id="start">Start</button>
        <button id="stop" style="background:#ff6b6b">Stop</button>
      </div>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="meta" class="meta">Progress: 0% — Successful: 0 — Requested: 0</div>
      <div id="extra" class="small"></div>
      <div class="log" id="log"></div>
      <div class="small" style="margin-top:8px">Auto-stop rules: (1) when Gained ≥ Target OR (2) when SuccessfulVisits doesn't increase for 5 polls</div>
    </div>
  </div>

<script>
const API_HIT = "/api/hit";
const API_LOGIN = "/api/login";

let running = false;
let baseline = null;
let uidGlobal = "";
let targetNeeded = 0;
let stalemateCount = 0;
const STALE_LIMIT = 5;      // stop if SuccessfulVisits doesn't increase for 5 polls
const POLL_INTERVAL = 1200; // ms between polls (adjust if upstream limits)

function log(msg){ const el = document.getElementById('log'); el.innerText = new Date().toLocaleTimeString() + " — " + msg + "\n" + el.innerText; }

document.getElementById('loginBtn').onclick = async () => {
  const user = document.getElementById('user').value;
  const pass = document.getElementById('pass').value;
  const fd = new URLSearchParams(); fd.append('user', user); fd.append('pass', pass);
  const r = await fetch(API_LOGIN, {method:'POST', body: fd});
  const j = await r.json().catch(()=>({ok:false}));
  if (r.ok && j.ok) {
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('panel').style.display = '';
    log("Login success");
  } else {
    document.getElementById('loginMsg').innerText = j.error || "Login failed";
    log("Login failed");
  }
};

document.getElementById('start').onclick = async () => {
  if (running) { alert("Already running"); return; }
  const uid = (document.getElementById('uid').value || "").trim();
  const needed = parseInt(document.getElementById('target').value || "0");
  if (!uid || !needed || needed <= 0) { alert("Enter UID and target visits"); return; }

  uidGlobal = uid;
  targetNeeded = needed;
  baseline = null;
  stalemateCount = 0;
  running = true;
  document.getElementById('bar').style.width = '0%';
  document.getElementById('meta').innerText = `Progress: 0% — Successful: 0 — Requested: ${targetNeeded}`;
  document.getElementById('extra').innerText = '';

  // init snapshot
  const initFd = new URLSearchParams(); initFd.append('uid', uidGlobal); initFd.append('action','init');
  try {
    const rInit = await fetch(API_HIT, {method:'POST', body: initFd});
    const jInit = await rInit.json();
    baseline = (typeof jInit.SuccessfulVisits === 'number') ? jInit.SuccessfulVisits : parseInt(jInit.SuccessfulVisits||0) || 0;
    log("Init snapshot SuccessfulVisits=" + baseline + " | Player:" + (jInit.api && jInit.api.PlayerNickname ? jInit.api.PlayerNickname : "N/A"));
    pollLoop(); // start polling loop
  } catch(e){
    log("Init error: " + e.toString());
    running = false;
  }
};

document.getElementById('stop').onclick = () => {
  if (!running) return;
  running = false;
  log("Stopped by user");
  alert("Stopped.");
};

async function pollLoop(){
  let lastSuccess = baseline;
  while(running){
    try {
      const fd = new URLSearchParams(); fd.append('uid', uidGlobal); fd.append('action','poll');
      const res = await fetch(API_HIT, {method:'POST', body: fd});
      if (!res.ok) {
        const err = await res.json().catch(()=>({error:'unknown'}));
        log("Upstream error: " + JSON.stringify(err));
        await sleep(POLL_INTERVAL); continue;
      }
      const j = await res.json();
      const cur = (typeof j.SuccessfulVisits === 'number') ? j.SuccessfulVisits : parseInt(j.SuccessfulVisits||0) || 0;
      const gained = cur - baseline;
      const percent = Math.max(0, Math.min(100, Math.round((gained / targetNeeded) * 10000) / 100));
      document.getElementById('bar').style.width = percent + '%';
      document.getElementById('meta').innerText = `Progress: ${percent}% — Successful: ${gained} — Requested: ${targetNeeded}`;
      // show some extras
      const nick = j.api && j.api.PlayerNickname ? j.api.PlayerNickname : "";
      const totalVisits = j.api && (j.api.TotalVisits || j.api.TotalVisits === 0) ? j.api.TotalVisits : "";
      const failed = j.api && (j.api.FailedVisits || j.api.FailedVisits === 0) ? j.api.FailedVisits : "";
      document.getElementById('extra').innerText = `UID: ${uidGlobal} ${nick ? "| Player: " + nick : ""} ${totalVisits ? "| TotalVisits: "+totalVisits : ""} ${failed ? "| Failed: "+failed : ""}`;
      log("Poll: SuccessfulVisits=" + cur + " | gained=" + gained);

      // stall detection
      if (cur <= lastSuccess) {
        stalemateCount += 1;
        log("No increase detected (" + stalemateCount + "/" + STALE_LIMIT + ")");
      } else {
        stalemateCount = 0;
      }
      lastSuccess = cur;

      // completion checks
      if (gained >= targetNeeded) {
        running = false;
        log("Target reached! gained=" + gained);
        alert("✅ Completed! Gained: " + gained);
        break;
      }
      if (stalemateCount >= STALE_LIMIT) {
        running = false;
        log("Stopped due to no progress for " + STALE_LIMIT + " polls. Last gained=" + gained);
        alert("Stopped — no further progress detected. Gained: " + gained);
        break;
      }
    } catch (e) {
      log("Exception poll: " + e.toString());
    }
    await sleep(POLL_INTERVAL);
  } // loop
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
</script>
</body>
</html>
