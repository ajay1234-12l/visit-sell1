<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Real Visit Panel — Live</title>
<style>
  body{font-family:Inter,Arial;background:#041226;color:#e6f6ff;margin:0;padding:18px;display:flex;justify-content:center}
  .card{width:380px;background:linear-gradient(180deg,#061226,#0a2740);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  h2{margin:0 0 12px 0;color:#8ee7ff}
  input,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:0;font-size:15px}
  input{background:#082033;color:#cfefff}
  button{background:#0ea5ff;color:#022;cursor:pointer;font-weight:700}
  .progress{height:18px;background:#08324a;border-radius:8px;overflow:hidden;margin-top:10px}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#00ff9e,#00a6ff);transition:width .3s}
  .meta{margin-top:8px;color:#bfefff;font-size:14px}
  .small{font-size:13px;color:#9fd8ff;margin-top:6px}
  .log{background:#021726;padding:8px;border-radius:8px;margin-top:10px;color:#bfefff;font-size:12px;height:110px;overflow:auto}
</style>
</head>
<body>
  <div class="card">
    <h2>Real Visit Panel</h2>

    <div id="loginArea">
      <input id="user" placeholder="Username (admin)" />
      <input id="pass" placeholder="Password (1234)" type="password" />
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="small"></div>
    </div>

    <div id="panel" style="display:none">
      <input id="uid" placeholder="UID (e.g. 1593717951)" />
      <input id="target" placeholder="Visits needed (e.g. 5000)" type="number" />
      <div style="display:flex;gap:8px">
        <button id="start">Start</button>
        <button id="stop" style="background:#ff6b6b">Stop</button>
      </div>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="meta" class="meta">Progress: 0% — Total Successful: 0 / 0</div>
      <div id="extra" class="small"></div>
      <div class="log" id="log"></div>
    </div>
  </div>

<script>
const API_HIT = "/api/hit";
const API_LOGIN = "/api/login";

let running = false;
let uidGlobal = "";
let targetNeeded = 0;
let totalGained = 0;   // ✅ New: keep cumulative SuccessfulVisits
let pollCount = 0;
const POLL_INTERVAL = 1200;

function log(msg){ const el = document.getElementById('log'); el.innerText = new Date().toLocaleTimeString() + " — " + msg + "\n" + el.innerText; }

document.getElementById('loginBtn').onclick = async () => {
  const user = document.getElementById('user').value;
  const pass = document.getElementById('pass').value;
  const fd = new URLSearchParams(); fd.append('user', user); fd.append('pass', pass);
  const r = await fetch(API_LOGIN, {method:'POST', body: fd});
  const j = await r.json().catch(()=>({ok:false}));
  if (r.ok && j.ok) {
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('panel').style.display = '';
    log("Login success");
  } else {
    document.getElementById('loginMsg').innerText = j.error || "Login failed";
    log("Login failed");
  }
};

document.getElementById('start').onclick = async () => {
  if (running) return alert("Already running");
  const uid = document.getElementById('uid').value.trim();
  const needed = parseInt(document.getElementById('target').value || "0");
  if (!uid || needed <= 0) return alert("Enter UID and target visits");

  uidGlobal = uid;
  targetNeeded = needed;
  totalGained = 0;
  pollCount = 0;
  running = true;
  document.getElementById('bar').style.width = '0%';
  document.getElementById('meta').innerText = `Progress: 0% — Total Successful: 0 / ${targetNeeded}`;
  log("Started session for UID=" + uid);
  pollLoop();
};

document.getElementById('stop').onclick = () => {
  if (!running) return;
  running = false;
  log("Stopped by user");
  alert("Stopped.");
};

async function pollLoop(){
  while (running) {
    try {
      const fd = new URLSearchParams(); fd.append('uid', uidGlobal);
      const res = await fetch(API_HIT, {method:'POST', body: fd});
      const j = await res.json();
      const succ = parseInt(j.SuccessfulVisits || 0);
      totalGained += succ;   // ✅ Add each value cumulatively
      pollCount++;

      const percent = Math.min(100, Math.round((totalGained / targetNeeded) * 10000) / 100);
      document.getElementById('bar').style.width = percent + "%";
      document.getElementById('meta').innerText = `Progress: ${percent}% — Total Successful: ${totalGained} / ${targetNeeded}`;
      log(`Poll ${pollCount}: +${succ} (added) => total ${totalGained}`);

      const api = j.api || {};
      const nick = api.PlayerNickname || "N/A";
      const totalVisits = api.TotalVisits ?? "?";
      const failed = api.FailedVisits ?? "?";
      document.getElementById('extra').innerText = `UID: ${uidGlobal} | Player: ${nick} | TotalVisits: ${totalVisits} | Failed: ${failed}`;

      if (totalGained >= targetNeeded) {
        running = false;
        log("✅ Completed! Total=" + totalGained);
        alert("✅ Target completed! Total gained: " + totalGained);
        break;
      }

    } catch(e) {
      log("Error: " + e.toString());
    }
    await sleep(POLL_INTERVAL);
  }
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
</script>
</body>
</html>
